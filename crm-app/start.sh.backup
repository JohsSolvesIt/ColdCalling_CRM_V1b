#!/bin/bash

echo "üöÄ Starting ColdCalling CRM Application..."
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Function to kill processes on specific ports
kill_port() {
    if command_exists lsof; then
        local port=$1
           echo "   ‚Ä¢ Press Ctrl+C to stop all servers"
    echo ""
    
    echo "üöÄ Starting auxiliary services with proper sequencing..."ng up port $port..."
        
        # Get all PIDs using this port
        local pids=$(lsof -ti :$port 2>/dev/null)
        
        if [ ! -z "$pids" ]; then
            # First try graceful kill
            echo "$pids" | xargs -r kill 2>/dev/null
            sleep 2
            
            # Check if any processes are still running
            local remaining_pids=$(lsof -ti :$port 2>/dev/null)
            if [ ! -z "$remaining_pids" ]; then
                echo "üî• Force killing stubborn processes on port $port..."
                echo "$remaining_pids" | xargs -r kill -9 2>/dev/null
                sleep 1
                
                # Final check with system-level kill
                local final_pids=$(lsof -ti :$port 2>/dev/null)
                if [ ! -z "$final_pids" ]; then
                    sudo kill -9 $final_pids 2>/dev/null || true
                    sleep 1
                fi
            fi
        fi
        
        # Also kill any node processes that might be related to this port
        pkill -f ":$port" 2>/dev/null || true
        pkill -f "port.*$port" 2>/dev/null || true
        
        # Verify the port is actually free
        if lsof -ti :$port >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  Warning: Port $port still appears to be in use"
        else
            echo "‚úÖ Port $port cleaned successfully"
        fi
    fi
}

# Check for Node.js and npm
if ! command_exists node; then
    echo "‚ùå Error: Node.js is not installed."
    echo "Please install Node.js from https://nodejs.org/ and try again."
    exit 1
fi

if ! command_exists npm; then
    echo "‚ùå Error: npm is not installed."
    echo "Please install npm and try again."
    exit 1
fi

# Check if we're in the right directory
if [ ! -f "package.json" ]; then
    echo "‚ùå Error: package.json not found. Please run this script from the crm-app directory."
    exit 1
fi

# Clean up any existing processes
echo "üßπ Cleaning up existing processes..."
kill_port 3000
kill_port 5000
kill_port 5001
kill_port 3030
kill_port 3031
kill_port 3032  # Add missing VvebJS port

# Install dependencies if missing
echo "üì¶ Checking dependencies..."
if [ ! -d "node_modules" ]; then
    echo "‚¨áÔ∏è  Installing backend dependencies..."
    npm install
    if [ $? -ne 0 ]; then
        echo "‚ùå Failed to install backend dependencies"
        exit 1
    fi
fi

if [ ! -d "client/node_modules" ]; then
    echo "‚¨áÔ∏è  Installing frontend dependencies..."
    cd client && npm install && cd ..
    if [ $? -ne 0 ]; then
        echo "‚ùå Failed to install frontend dependencies"
        exit 1
    fi
fi

# Check and install Chrome Extension backend dependencies
echo "üì¶ Checking Chrome Extension backend dependencies..."
if [ ! -d "../chromeExtensionRealtor/backend/node_modules" ]; then
    echo "‚¨áÔ∏è  Installing Chrome Extension backend dependencies..."
    cd ../chromeExtensionRealtor/backend && npm install && cd ../../crm-app
    if [ $? -ne 0 ]; then
        echo "‚ùå Failed to install Chrome Extension backend dependencies"
        exit 1
    fi
else
    echo "‚úÖ Chrome Extension backend dependencies already installed"
fi

# Check and install VvebJS dependencies
echo "üì¶ Checking VvebJS dependencies..."
if [ ! -d "../vvebjs/node_modules" ]; then
    echo "‚¨áÔ∏è  Installing VvebJS dependencies..."
    cd ../vvebjs && npm install && cd ../crm-app
    if [ $? -ne 0 ]; then
        echo "‚ùå Failed to install VvebJS dependencies"
        exit 1
    fi
else
    echo "‚úÖ VvebJS dependencies already installed"
fi

# Ensure .env file exists for Chrome Extension backend
echo "üîß Checking Chrome Extension backend configuration..."
if [ ! -f "../chromeExtensionRealtor/backend/.env" ]; then
    if [ -f "../chromeExtensionRealtor/backend/.env.example" ]; then
        echo "üìù Creating .env file from .env.example..."
        cd ../chromeExtensionRealtor/backend
        cp .env.example .env
        # Update the port to 5001
        sed -i 's/PORT=3001/PORT=5001/' .env
        cd ../../crm-app
    else
        echo "üìù Creating basic .env file..."
        cat > ../chromeExtensionRealtor/backend/.env << EOF
# Database Configuration
DB_HOST=localhost
DB_PORT=5432
DB_NAME=realtor_data
DB_USER=postgres
DB_PASSWORD=

# Server Configuration
PORT=5001
NODE_ENV=development

# Logging
LOG_LEVEL=info

# Security
JWT_SECRET=dev_secret_change_in_production
EOF
    fi
    echo "‚úÖ Chrome Extension backend .env file configured"
fi

# Function to start Chrome Extension backend
start_chrome_extension_backend() {
    echo "üöÄ Starting Chrome Extension backend on port 5001..."
    cd ../chromeExtensionRealtor/backend
    
    # Ensure logs directory exists
    mkdir -p logs
    
    # Clear old logs
    > logs/error.log
    > logs/combined.log
    
    # Start the backend with proper error handling
    npm start > logs/startup.log 2>&1 &
    CHROME_EXT_PID=$!
    cd ../../crm-app
    
    # Wait and verify the backend started
    echo "‚è≥ Waiting for Chrome Extension backend to start..."
    sleep 5
    
    if kill -0 $CHROME_EXT_PID 2>/dev/null; then
        echo "‚úÖ Chrome Extension backend started successfully (PID: $CHROME_EXT_PID)"
        
        # Test the health endpoint with multiple attempts
        local attempts=0
        local max_attempts=6
        while [ $attempts -lt $max_attempts ]; do
            if command_exists curl; then
                if curl -s http://localhost:5001/health >/dev/null 2>&1; then
                    echo "‚úÖ Chrome Extension backend health check passed"
                    return 0
                fi
            fi
            attempts=$((attempts + 1))
            if [ $attempts -lt $max_attempts ]; then
                echo "‚è≥ Health check attempt $attempts/$max_attempts failed, retrying..."
                sleep 2
            fi
        done
        echo "‚ö†Ô∏è  Chrome Extension backend started but health check failed (this may be normal if backend is still initializing)"
    else
        echo "‚ùå Chrome Extension backend failed to start"
        if [ -f "../chromeExtensionRealtor/backend/logs/startup.log" ]; then
            echo "üìã Startup log:"
            tail -20 ../chromeExtensionRealtor/backend/logs/startup.log
        fi
        if [ -f "../chromeExtensionRealtor/backend/logs/error.log" ]; then
            echo "üìã Error log:"
            tail -10 ../chromeExtensionRealtor/backend/logs/error.log
        fi
        return 1
    fi
}

# Function to start VvebJS server
start_vvebjs_server() {
    echo "üöÄ Starting VvebJS server on port 3030..."
    cd ../vvebjs
    
    # Start the VvebJS static server for realtor pages
    npm run serve-realtor > vvebjs-static.log 2>&1 &
    VVEBJS_STATIC_PID=$!
    
    # Also start the API server on port 3032
    echo "üöÄ Starting VvebJS API server on port 3032..."
    npm run start-api > vvebjs-api.log 2>&1 &
    VVEBJS_API_PID=$!
    
    cd ../crm-app
    
    # Wait and verify both servers started
    echo "‚è≥ Waiting for VvebJS servers to start..."
    sleep 5
    
    local success=true
    
    if kill -0 $VVEBJS_STATIC_PID 2>/dev/null; then
        echo "‚úÖ VvebJS static server started successfully (PID: $VVEBJS_STATIC_PID)"
    else
        echo "‚ùå VvebJS static server failed to start"
        success=false
    fi
    
    if kill -0 $VVEBJS_API_PID 2>/dev/null; then
        echo "‚úÖ VvebJS API server started successfully (PID: $VVEBJS_API_PID)"
    else
        echo "‚ùå VvebJS API server failed to start"
        success=false
    fi
    
    if [ "$success" = true ]; then
        # Test the servers with multiple attempts
        local attempts=0
        local max_attempts=5
        while [ $attempts -lt $max_attempts ]; do
            if command_exists curl; then
                if curl -s http://localhost:3030/ >/dev/null 2>&1 && curl -s http://localhost:3032/ >/dev/null 2>&1; then
                    echo "‚úÖ VvebJS servers health check passed"
                    return 0
                fi
            fi
            attempts=$((attempts + 1))
            if [ $attempts -lt $max_attempts ]; then
                echo "‚è≥ VvebJS health check attempt $attempts/$max_attempts failed, retrying..."
                sleep 2
            fi
        done
        echo "‚ö†Ô∏è  VvebJS servers started but health check failed (this may be normal if servers are still initializing)"
        return 0
    else
        echo "‚ùå One or more VvebJS servers failed to start"
        if [ -f "../vvebjs/vvebjs-static.log" ]; then
            echo "üìã VvebJS static server log:"
            tail -10 ../vvebjs/vvebjs-static.log
        fi
        if [ -f "../vvebjs/vvebjs-api.log" ]; then
            echo "üìã VvebJS API server log:"
            tail -10 ../vvebjs/vvebjs-api.log
        fi
        return 1
    fi
}

# Function to start VvebJS Save Server
start_vvebjs_save_server() {
    echo "üöÄ Starting VvebJS Save Server on port 3031..."
    cd ../vvebjs
    
    # Start the VvebJS Save Server
    npm run start-save-server > save-server.log 2>&1 &
    VVEBJS_SAVE_PID=$!
    cd ../crm-app
    
    # Wait and verify the server started
    echo "‚è≥ Waiting for VvebJS Save Server to start..."
    sleep 3
    
    if kill -0 $VVEBJS_SAVE_PID 2>/dev/null; then
        echo "‚úÖ VvebJS Save Server started successfully (PID: $VVEBJS_SAVE_PID)"
        
        # Test the server with multiple attempts
        local attempts=0
        local max_attempts=5
        while [ $attempts -lt $max_attempts ]; do
            if command_exists curl; then
                if curl -s http://localhost:3031/health >/dev/null 2>&1; then
                    echo "‚úÖ VvebJS Save Server health check passed"
                    return 0
                fi
            fi
            attempts=$((attempts + 1))
            if [ $attempts -lt $max_attempts ]; then
                echo "‚è≥ VvebJS Save Server health check attempt $attempts/$max_attempts failed, retrying..."
                sleep 2
            fi
        done
        echo "‚ö†Ô∏è  VvebJS Save Server started but health check failed (this may be normal if server is still initializing)"
    else
        echo "‚ùå VvebJS Save Server failed to start"
        if [ -f "../vvebjs/save-server.log" ]; then
            echo "üìã VvebJS Save Server log:"
            tail -10 ../vvebjs/save-server.log
        fi
        return 1
    fi
}

# Function to monitor Chrome Extension backend
monitor_chrome_extension() {
    while true; do
        if ! kill -0 $CHROME_EXT_PID 2>/dev/null; then
            echo "‚ö†Ô∏è  Chrome Extension backend crashed, restarting..."
            start_chrome_extension_backend
        fi
        sleep 5
    done
}

# Function to monitor VvebJS server
monitor_vvebjs() {
    while true; do
        if ! kill -0 $VVEBJS_PID 2>/dev/null; then
            echo "‚ö†Ô∏è  VvebJS server crashed, restarting..."
            start_vvebjs_server
        fi
        sleep 5
    done
}

# Function to monitor VvebJS Save Server
monitor_vvebjs_save() {
    while true; do
        if ! kill -0 $VVEBJS_SAVE_PID 2>/dev/null; then
            echo "‚ö†Ô∏è  VvebJS Save Server crashed, restarting..."
            start_vvebjs_save_server
        fi
        sleep 5
    done
}

# Determine startup mode
echo ""
echo "üîß Starting CRM in Development Mode..."
echo "   ‚Ä¢ Frontend (React): http://localhost:3000 (Hot Reload)"
echo "   ‚Ä¢ Backend (API): http://localhost:5000"
echo "   ‚Ä¢ Chrome Extension Backend: http://localhost:5001"
echo "   ‚Ä¢ VvebJS Server: http://localhost:3030"
echo "   ‚Ä¢ VvebJS Save Server: http://localhost:3031"
echo "   ‚Ä¢ All servers will start automatically"
echo ""

# Check if concurrently is available for running both servers
if npm list concurrently >/dev/null 2>&1; then
    echo "üéØ Launching all servers (Frontend, Backend, Chrome Extension, VvebJS)..."
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo ""
    echo "üí° Tips:"
    echo "   ‚Ä¢ Your browser will open automatically to http://localhost:3000"
    echo "   ‚Ä¢ Changes to frontend code will auto-reload"
    echo "   ‚Ä¢ Changes to backend code will auto-restart"
    echo "   ‚Ä¢ Chrome Extension backend provides realtor data at port 5001"
    echo "   ‚Ä¢ VvebJS editor and realtor pages available at port 3030"
    echo "   ‚Ä¢ Access VvebJS editor: http://localhost:3030/editor.html"
    echo "   ‚Ä¢ Access realtor directory: http://localhost:3030/generated-realtors/"
    echo "   ‚Ä¢ Press Ctrl+C to stop all servers"
    echo ""
    
    # Start auxiliary services (Chrome Extension backend, VvebJS) - DISABLED due to port conflicts
    echo "‚ö†Ô∏è  Auxiliary services temporarily disabled to prevent port conflicts"
    echo "‚úÖ Core CRM is fully functional with enhanced themes!"
    echo ""
    echo "üé® Your enhanced themes are ready:"
    echo "   ‚Ä¢ Ultra Premium (luxury navy & gold)"
    echo "   ‚Ä¢ Neon Cyber (futuristic cyberpunk)"
    echo "   ‚Ä¢ Modern Professional (enhanced)"
    echo "   ‚Ä¢ Classic Elegant (enhanced)"
    echo "   ‚Ä¢ And more!"
    echo ""
    
    echo "üöÄ Now starting auxiliary services with proper sequencing..."
    
    # Start Chrome Extension backend with delay
    echo "üöÄ Starting Chrome Extension backend..."
    start_chrome_extension_backend
    echo "‚è≥ Allowing Chrome Extension backend to stabilize..."
    sleep 3
    
    # Start VvebJS servers with delay
    echo "üöÄ Starting VvebJS servers..."
    start_vvebjs_server
    echo "‚è≥ Allowing VvebJS servers to stabilize..."
    sleep 3
    
    # Start VvebJS Save Server with delay
    echo "üöÄ Starting VvebJS Save Server..."
    start_vvebjs_save_server
    echo "‚è≥ Allowing VvebJS Save Server to stabilize..."
    sleep 3
    
    echo "‚úÖ All auxiliary services started with proper delays"
    
    # Skip monitoring for now - let's see if services stay stable first
    # monitor_chrome_extension &
    # MONITOR_PID=$!
    
    # monitor_vvebjs &
    # VVEBJS_MONITOR_PID=$!
    
    # monitor_vvebjs_save &
    # VVEBJS_SAVE_MONITOR_PID=$!
    
    # Wait a moment for all services to fully initialize
    sleep 5
    
    # Try to open browser automatically after a delay
    if command_exists xdg-open; then
        (sleep 5 && xdg-open http://localhost:3000) &
    elif command_exists open; then
        (sleep 5 && open http://localhost:3000) &
    fi
    
    # Setup cleanup function
    cleanup() {
        echo ""
        echo "üõë Shutting down all servers..."
        kill $CHROME_EXT_PID 2>/dev/null
        kill $VVEBJS_PID 2>/dev/null
        kill $VVEBJS_SAVE_PID 2>/dev/null
        kill $MONITOR_PID 2>/dev/null
        kill $VVEBJS_MONITOR_PID 2>/dev/null
        kill $VVEBJS_SAVE_MONITOR_PID 2>/dev/null
        kill_port 5001
        kill_port 3030
        kill_port 3031
        exit 0
    }
    trap cleanup SIGINT SIGTERM
    
    # Start both CRM servers using concurrently with better output
    npm run dev
else
    echo "‚ö†Ô∏è  Starting servers manually (concurrently not available)..."
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo ""
    echo "üîß Manual Setup:"
    echo "   1. Starting Chrome Extension backend on port 5001"
    echo "   2. Starting VvebJS server on port 3030"
    echo "   3. Starting VvebJS Save Server on port 3031"
    echo "   4. This terminal will start the CRM backend server on port 5000"
    echo "   5. Open another terminal and run: cd client && npm start"
    echo "   6. Frontend will be at http://localhost:3000"
    echo "   7. Backend will be at http://localhost:5000"
    echo "   8. Chrome Extension backend will be at http://localhost:5001"
    echo "   9. VvebJS editor will be at http://localhost:3030/editor.html"
    echo "   10. Realtor directory will be at http://localhost:3030/generated-realtors/"
    echo "   11. VvebJS Save API will be at http://localhost:3031"
    echo ""
    
    # Start Chrome Extension backend in background
    echo "üöÄ Starting Chrome Extension backend..."
    start_chrome_extension_backend
    
    # Wait for Chrome Extension to fully stabilize
    echo "‚è≥ Allowing Chrome Extension backend to stabilize..."
    sleep 3
    
    # Start VvebJS server in background
    echo "üöÄ Starting VvebJS server..."
    start_vvebjs_server
    
    # Wait for VvebJS server to stabilize
    echo "‚è≥ Allowing VvebJS server to stabilize..."
    sleep 3
    
    # Start VvebJS Save Server in background
    echo "üöÄ Starting VvebJS Save Server..."
    start_vvebjs_save_server
    
    # Wait for Save Server to stabilize
    echo "‚è≥ Allowing VvebJS Save Server to stabilize..."
    sleep 3
    
    # Start monitoring in background
    monitor_chrome_extension &
    MONITOR_PID=$!
    
    monitor_vvebjs &
    VVEBJS_MONITOR_PID=$!
    
    monitor_vvebjs_save &
    VVEBJS_SAVE_MONITOR_PID=$!
    
    # Wait a moment for all services to start
    sleep 4
    
    # Setup cleanup function
    cleanup() {
        echo ""
        echo "üõë Shutting down Chrome Extension backend, VvebJS server, and VvebJS Save Server..."
        kill $CHROME_EXT_PID 2>/dev/null
        kill $VVEBJS_PID 2>/dev/null
        kill $VVEBJS_SAVE_PID 2>/dev/null
        kill $MONITOR_PID 2>/dev/null
        kill $VVEBJS_MONITOR_PID 2>/dev/null
        kill $VVEBJS_SAVE_MONITOR_PID 2>/dev/null
        kill_port 5001
        kill_port 3030
        kill_port 3031
        exit 0
    }
    trap cleanup SIGINT SIGTERM
    
    read -p "Press Enter to start the CRM backend server..."
    
    echo "üñ•Ô∏è  Starting CRM backend server..."
    npm run server
fi
